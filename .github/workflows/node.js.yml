name: Playwright-Cucumber CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------
      # 1Ô∏è‚É£ Checkout Repo
      # ----------------------------------------------
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------
      # 2Ô∏è‚É£ Debug Files at Root
      # ----------------------------------------------
      - name: üîç Debug Repository Files
        run: ls -R

      # ----------------------------------------------
      # 3Ô∏è‚É£ Setup Node.js
      # ----------------------------------------------
      - name: üîß Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ----------------------------------------------
      # 4Ô∏è‚É£ Install Dependencies
      # ----------------------------------------------
      - name: üì¶ Install Dependencies
        run: npm install --no-fund --no-audit

      # ----------------------------------------------
      # 5Ô∏è‚É£ Install Playwright Browsers
      # ----------------------------------------------
      - name: üé≠ Install Playwright Browsers
        run: npx playwright install --with-deps

      # ----------------------------------------------
      # 6Ô∏è‚É£ Find testdata.json
      # ----------------------------------------------
      - name: üìù Find testdata.json in Repository
        run: |
          echo "PWD: $(pwd)"
          find . -type f | grep -i "testdata.json" || echo "‚ö†Ô∏è testdata.json NOT FOUND!"

      # ----------------------------------------------
      # 7Ô∏è‚É£ Check Git Ignore Status
      # ----------------------------------------------
      - name: üîç Check if testdata.json is ignored
        run: |
          git check-ignore -v ./playwright-automation/TestData/testdata.json || \
          echo "‚úÖ testdata.json is NOT ignored!"

      # ----------------------------------------------
      # 8Ô∏è‚É£ Ensure testdata.json is tracked
      # ----------------------------------------------
      - name: üìÇ Ensure testdata.json is Tracked in Git
        run: |
          git ls-files --stage | grep testdata.json || \
          echo "‚ö†Ô∏è testdata.json NOT tracked by Git!"

      # ----------------------------------------------
      # 9Ô∏è‚É£ Run Tests
      # ----------------------------------------------
      - name: üõ† Run Smoke Tests with Cucumber & Playwright
        run: |
          mkdir -p playwright-automation/test-results
          npm run test:smoke || echo "‚ùå Tests failed (continuing for artifacts)"

      # ----------------------------------------------
      # üîü Check Screenshots
      # ----------------------------------------------
      - name: üîç Check if Screenshots Exist
        run: |
          if ls playwright-automation/test-results/*.png 1> /dev/null 2>&1; then
            echo "‚úÖ Screenshots captured!"
          else
            echo "‚ö†Ô∏è No screenshots found!"
          fi

      # ----------------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Upload Artifacts
      # ----------------------------------------------
      - name: üìÇ Upload Playwright Artifacts (Screenshots & Traces)
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: playwright-automation/test-results/
          if-no-files-found: ignore
